import { getWeatherForecast } from './api';
import { API_KEY, BASE_URL } from './constants';

jest.mock('node-fetch');
import fetch, { Response } from 'node-fetch';

describe('API Helper', () => {
  const city = 'chennai';
  const units = 'metric';
  const mockResponse =
    '{"cod":"200","message":0,"cnt":40,"list":[{"dt":1606424400,"main":{"temp":22.8,"feels_like":20.36,"temp_min":22.59,"temp_max":22.8,"pressure":1008,"sea_level":1008,"grnd_level":1006,"humidity":90,"temp_kf":0.21},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":94},"wind":{"speed":9.52,"deg":309},"visibility":10000,"pop":0.54,"rain":{"3h":0.18},"sys":{"pod":"n"},"dt_txt":"2020-11-26 21:00:00"},{"dt":1606435200,"main":{"temp":22.2,"feels_like":20.1,"temp_min":21.98,"temp_max":22.2,"pressure":1008,"sea_level":1008,"grnd_level":1007,"humidity":89,"temp_kf":0.22},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":97},"wind":{"speed":8.49,"deg":271},"visibility":10000,"pop":0.63,"rain":{"3h":2.02},"sys":{"pod":"n"},"dt_txt":"2020-11-27 00:00:00"},{"dt":1606446000,"main":{"temp":22.62,"feels_like":20.83,"temp_min":22.59,"temp_max":22.62,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":85,"temp_kf":0.03},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":98},"wind":{"speed":7.82,"deg":304},"visibility":10000,"pop":0.35,"rain":{"3h":0.19},"sys":{"pod":"d"},"dt_txt":"2020-11-27 03:00:00"},{"dt":1606456800,"main":{"temp":23.67,"feels_like":23.46,"temp_min":23.67,"temp_max":23.68,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":81,"temp_kf":-0.01},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":98},"wind":{"speed":5.73,"deg":307},"visibility":10000,"pop":0.4,"rain":{"3h":0.2},"sys":{"pod":"d"},"dt_txt":"2020-11-27 06:00:00"},{"dt":1606467600,"main":{"temp":24.23,"feels_like":24.92,"temp_min":24.23,"temp_max":24.23,"pressure":1008,"sea_level":1008,"grnd_level":1006,"humidity":78,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":80},"wind":{"speed":4.39,"deg":296},"visibility":10000,"pop":0.03,"sys":{"pod":"d"},"dt_txt":"2020-11-27 09:00:00"},{"dt":1606478400,"main":{"temp":24.62,"feels_like":27.31,"temp_min":24.62,"temp_max":24.62,"pressure":1009,"sea_level":1009,"grnd_level":1008,"humidity":77,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":76},"wind":{"speed":1.65,"deg":201},"visibility":10000,"pop":0.03,"sys":{"pod":"d"},"dt_txt":"2020-11-27 12:00:00"},{"dt":1606489200,"main":{"temp":24.06,"feels_like":26.93,"temp_min":24.06,"temp_max":24.06,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":80,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":56},"wind":{"speed":1.44,"deg":150},"visibility":10000,"pop":0.01,"sys":{"pod":"n"},"dt_txt":"2020-11-27 15:00:00"},{"dt":1606500000,"main":{"temp":24.13,"feels_like":26.42,"temp_min":24.13,"temp_max":24.13,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":81,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":62},"wind":{"speed":2.47,"deg":107},"visibility":10000,"pop":0.01,"sys":{"pod":"n"},"dt_txt":"2020-11-27 18:00:00"},{"dt":1606510800,"main":{"temp":24.36,"feels_like":27.03,"temp_min":24.36,"temp_max":24.36,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":80,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":69},"wind":{"speed":1.94,"deg":71},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2020-11-27 21:00:00"},{"dt":1606521600,"main":{"temp":24.62,"feels_like":26.85,"temp_min":24.62,"temp_max":24.62,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":80,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":79},"wind":{"speed":2.74,"deg":35},"visibility":10000,"pop":0,"sys":{"pod":"n"},"dt_txt":"2020-11-28 00:00:00"},{"dt":1606532400,"main":{"temp":25.88,"feels_like":27.63,"temp_min":25.88,"temp_max":25.88,"pressure":1014,"sea_level":1014,"grnd_level":1012,"humidity":77,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":68},"wind":{"speed":3.87,"deg":23},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2020-11-28 03:00:00"},{"dt":1606543200,"main":{"temp":27.22,"feels_like":29.04,"temp_min":27.22,"temp_max":27.22,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":72,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":79},"wind":{"speed":3.9,"deg":41},"visibility":10000,"pop":0,"sys":{"pod":"d"},"dt_txt":"2020-11-28 06:00:00"},{"dt":1606554000,"main":{"temp":27.7,"feels_like":29.6,"temp_min":27.7,"temp_max":27.7,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":70,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":46},"wind":{"speed":3.79,"deg":52},"visibility":10000,"pop":0.02,"sys":{"pod":"d"},"dt_txt":"2020-11-28 09:00:00"},{"dt":1606564800,"main":{"temp":26.68,"feels_like":29.11,"temp_min":26.68,"temp_max":26.68,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":76,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":37},"wind":{"speed":3.31,"deg":38},"visibility":10000,"pop":0.04,"sys":{"pod":"d"},"dt_txt":"2020-11-28 12:00:00"},{"dt":1606575600,"main":{"temp":25.79,"feels_like":28.31,"temp_min":25.79,"temp_max":25.79,"pressure":1014,"sea_level":1014,"grnd_level":1012,"humidity":81,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":10},"wind":{"speed":3.33,"deg":357},"visibility":6994,"pop":0.56,"rain":{"3h":1.84},"sys":{"pod":"n"},"dt_txt":"2020-11-28 15:00:00"},{"dt":1606586400,"main":{"temp":24.31,"feels_like":25.6,"temp_min":24.31,"temp_max":24.31,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":87,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":24},"wind":{"speed":4.87,"deg":342},"visibility":10000,"pop":0.76,"rain":{"3h":1.76},"sys":{"pod":"n"},"dt_txt":"2020-11-28 18:00:00"},{"dt":1606597200,"main":{"temp":24.15,"feels_like":25.83,"temp_min":24.15,"temp_max":24.15,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":89,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":40},"wind":{"speed":4.48,"deg":358},"visibility":8319,"pop":0.73,"rain":{"3h":1.54},"sys":{"pod":"n"},"dt_txt":"2020-11-28 21:00:00"},{"dt":1606608000,"main":{"temp":25.31,"feels_like":27.47,"temp_min":25.31,"temp_max":25.31,"pressure":1012,"sea_level":1012,"grnd_level":1010,"humidity":85,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":69},"wind":{"speed":4.09,"deg":38},"visibility":8233,"pop":0.84,"rain":{"3h":4.1},"sys":{"pod":"n"},"dt_txt":"2020-11-29 00:00:00"},{"dt":1606618800,"main":{"temp":26.91,"feels_like":27.73,"temp_min":26.91,"temp_max":26.91,"pressure":1014,"sea_level":1014,"grnd_level":1013,"humidity":79,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":99},"wind":{"speed":6.28,"deg":57},"visibility":10000,"pop":0.99,"rain":{"3h":2.78},"sys":{"pod":"d"},"dt_txt":"2020-11-29 03:00:00"},{"dt":1606629600,"main":{"temp":27.76,"feels_like":27.97,"temp_min":27.76,"temp_max":27.76,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":76,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":61},"wind":{"speed":7.3,"deg":56},"visibility":9133,"pop":1,"rain":{"3h":2.13},"sys":{"pod":"d"},"dt_txt":"2020-11-29 06:00:00"},{"dt":1606640400,"main":{"temp":28.05,"feels_like":27.66,"temp_min":28.05,"temp_max":28.05,"pressure":1010,"sea_level":1010,"grnd_level":1008,"humidity":73,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":20},"wind":{"speed":7.85,"deg":47},"visibility":10000,"pop":0.8,"rain":{"3h":1.09},"sys":{"pod":"d"},"dt_txt":"2020-11-29 09:00:00"},{"dt":1606651200,"main":{"temp":26.88,"feels_like":26.86,"temp_min":26.88,"temp_max":26.88,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":78,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":31},"wind":{"speed":7.29,"deg":41},"visibility":10000,"pop":0.8,"rain":{"3h":0.12},"sys":{"pod":"d"},"dt_txt":"2020-11-29 12:00:00"},{"dt":1606662000,"main":{"temp":26.59,"feels_like":26.6,"temp_min":26.59,"temp_max":26.59,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":79,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":86},"wind":{"speed":7.2,"deg":42},"visibility":10000,"pop":0.33,"rain":{"3h":0.27},"sys":{"pod":"n"},"dt_txt":"2020-11-29 15:00:00"},{"dt":1606672800,"main":{"temp":26.17,"feels_like":26.77,"temp_min":26.17,"temp_max":26.17,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":81,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":77},"wind":{"speed":6.36,"deg":39},"visibility":10000,"pop":0.35,"rain":{"3h":0.51},"sys":{"pod":"n"},"dt_txt":"2020-11-29 18:00:00"},{"dt":1606683600,"main":{"temp":25.99,"feels_like":26.17,"temp_min":25.99,"temp_max":25.99,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":82,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":95},"wind":{"speed":6.98,"deg":35},"visibility":10000,"pop":0.43,"rain":{"3h":0.71},"sys":{"pod":"n"},"dt_txt":"2020-11-29 21:00:00"},{"dt":1606694400,"main":{"temp":26.01,"feels_like":25.96,"temp_min":26.01,"temp_max":26.01,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":80,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":95},"wind":{"speed":7.01,"deg":31},"visibility":10000,"pop":0.32,"rain":{"3h":0.12},"sys":{"pod":"n"},"dt_txt":"2020-11-30 00:00:00"},{"dt":1606705200,"main":{"temp":27.3,"feels_like":26.79,"temp_min":27.3,"temp_max":27.3,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":77,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":43},"wind":{"speed":8.15,"deg":44},"visibility":10000,"pop":0.32,"rain":{"3h":0.28},"sys":{"pod":"d"},"dt_txt":"2020-11-30 03:00:00"},{"dt":1606716000,"main":{"temp":28.37,"feels_like":27.45,"temp_min":28.37,"temp_max":28.37,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":70,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":40},"wind":{"speed":8.3,"deg":43},"visibility":10000,"pop":0.42,"rain":{"3h":0.13},"sys":{"pod":"d"},"dt_txt":"2020-11-30 06:00:00"},{"dt":1606726800,"main":{"temp":28.07,"feels_like":27.17,"temp_min":28.07,"temp_max":28.07,"pressure":1010,"sea_level":1010,"grnd_level":1008,"humidity":71,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":82},"wind":{"speed":8.24,"deg":37},"visibility":10000,"pop":0.09,"sys":{"pod":"d"},"dt_txt":"2020-11-30 09:00:00"},{"dt":1606737600,"main":{"temp":26.72,"feels_like":26.26,"temp_min":26.72,"temp_max":26.72,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":77,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":84},"wind":{"speed":7.64,"deg":30},"visibility":10000,"pop":0.06,"sys":{"pod":"d"},"dt_txt":"2020-11-30 12:00:00"},{"dt":1606748400,"main":{"temp":26.54,"feels_like":26.13,"temp_min":26.54,"temp_max":26.54,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":78,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":85},"wind":{"speed":7.59,"deg":27},"visibility":10000,"pop":0.33,"rain":{"3h":0.11},"sys":{"pod":"n"},"dt_txt":"2020-11-30 15:00:00"},{"dt":1606759200,"main":{"temp":26.05,"feels_like":26.13,"temp_min":26.05,"temp_max":26.05,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":81,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":92},"wind":{"speed":7,"deg":21},"visibility":10000,"pop":0.12,"sys":{"pod":"n"},"dt_txt":"2020-11-30 18:00:00"},{"dt":1606770000,"main":{"temp":25.72,"feels_like":25.48,"temp_min":25.72,"temp_max":25.72,"pressure":1011,"sea_level":1011,"grnd_level":1009,"humidity":82,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":73},"wind":{"speed":7.37,"deg":22},"visibility":10000,"pop":0.32,"rain":{"3h":0.23},"sys":{"pod":"n"},"dt_txt":"2020-11-30 21:00:00"},{"dt":1606780800,"main":{"temp":25.53,"feels_like":25.09,"temp_min":25.53,"temp_max":25.53,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":83,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":67},"wind":{"speed":7.67,"deg":18},"visibility":10000,"pop":0.21,"rain":{"3h":0.19},"sys":{"pod":"n"},"dt_txt":"2020-12-01 00:00:00"},{"dt":1606791600,"main":{"temp":26.58,"feels_like":25.07,"temp_min":26.58,"temp_max":26.58,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":78,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":9.2,"deg":22},"visibility":10000,"pop":0.36,"rain":{"3h":0.19},"sys":{"pod":"d"},"dt_txt":"2020-12-01 03:00:00"},{"dt":1606802400,"main":{"temp":27.44,"feels_like":25.23,"temp_min":27.44,"temp_max":27.44,"pressure":1013,"sea_level":1013,"grnd_level":1011,"humidity":73,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":10,"deg":26},"visibility":10000,"pop":0.4,"rain":{"3h":0.48},"sys":{"pod":"d"},"dt_txt":"2020-12-01 06:00:00"},{"dt":1606813200,"main":{"temp":27.55,"feels_like":24.94,"temp_min":27.55,"temp_max":27.55,"pressure":1010,"sea_level":1010,"grnd_level":1008,"humidity":72,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":10.47,"deg":32},"visibility":10000,"pop":0.46,"rain":{"3h":0.58},"sys":{"pod":"d"},"dt_txt":"2020-12-01 09:00:00"},{"dt":1606824000,"main":{"temp":26.5,"feels_like":24.45,"temp_min":26.5,"temp_max":26.5,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":75,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":97},"wind":{"speed":9.41,"deg":31},"visibility":10000,"pop":0.42,"rain":{"3h":0.32},"sys":{"pod":"d"},"dt_txt":"2020-12-01 12:00:00"},{"dt":1606834800,"main":{"temp":26.49,"feels_like":24.5,"temp_min":26.49,"temp_max":26.49,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":75,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":98},"wind":{"speed":9.32,"deg":32},"visibility":10000,"pop":0.42,"rain":{"3h":0.22},"sys":{"pod":"n"},"dt_txt":"2020-12-01 15:00:00"},{"dt":1606845600,"main":{"temp":26.02,"feels_like":24.69,"temp_min":26.02,"temp_max":26.02,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":80,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":99},"wind":{"speed":8.84,"deg":34},"visibility":10000,"pop":0.55,"rain":{"3h":0.9},"sys":{"pod":"n"},"dt_txt":"2020-12-01 18:00:00"}],"city":{"id":1264527,"name":"Chennai","coord":{"lat":13.0878,"lon":80.2785},"country":"IN","population":4328063,"timezone":19800,"sunrise":1606437825,"sunset":1606478986}}';
  it('should call fetch with the right args and return weather data', async () => {
    const returnValue = new Promise((resolve, reject) => {
      resolve({
        json: () =>
          new Promise((resolve, reject) => {
            resolve(JSON.parse(mockResponse));
          }),
      });
    });
    fetch.mockReturnValue(returnValue);

    const result = await getWeatherForecast(city, units);
    expect(fetch).toHaveBeenCalledTimes(1);
    expect(fetch).toHaveBeenCalledWith(
      `${BASE_URL}?q=${city}&appid=${API_KEY}&units=${units}`
    );
    expect(result).toEqual(JSON.parse(mockResponse));
  });
  it('should throw error on api error', async () => {
    const errorResponse = '{"cod":"404","message":"city not found"}';
    const returnValue = new Promise((resolve, reject) => {
      resolve({
        json: () =>
          new Promise((resolve, reject) => {
            resolve(JSON.parse(errorResponse));
          }),
      });
    });
    fetch.mockReturnValue(returnValue);
    try {
      await getWeatherForecast(city, units);
    } catch (e) {
      expect(e).toEqual(JSON.parse(errorResponse));
    }
  });
  it('should throw error on fetch error', async () => {
    const returnValue = new Promise((resolve, reject) => {
      reject();
    });
    fetch.mockReturnValue(returnValue);
    try {
      await getWeatherForecast(city, units);
    } catch (e) {
      expect(e.message).toBeDefined();
    }
  });
});
